{{ define "main" }}
<main class="min-h-screen flex flex-col items-center bg-inherit text-white px-0 py-0">
  <h1 class="text-3xl font-bold text-center mb-4 tracking-wide">{{ .Title }}</h1>

<div id="parallax-container"
     class="relative w-full -mx-4 sm:-mx-6 lg:mx-auto lg:max-w-2xl aspect-[1/1] mb-2 overflow-visible border-0 lg:border lg:border-zinc-800 bg-inherit rounded-none lg:rounded-2xl">
  
  <!-- Stage Background (static) -->
  <img src="/images/stage.jpg" alt="Stage background"
       class="absolute inset-0 w-full h-full object-cover" />	

  <!-- Product images wrapper (for parallax/tilt) -->
  <div id="product-wrapper" class="absolute inset-0 w-full h-full transition-transform duration-300 ease-out will-change-transform">
    <!-- Product Image A -->
    {{ $fallback := "/images/missing.jpg" }}
    {{ $defaultColor := .Params.default_color }}
    {{ $default := or (.Resources.GetMatch $defaultColor) (.Resources.GetMatch (print $defaultColor ".jpeg")) }}
    {{ $default = or $default (.Resources.GetMatch (print $defaultColor ".png")) }}
    {{ $default = or $default (.Resources.GetMatch (print $defaultColor ".webp")) }}
	<img
      id="product-a"
      src="{{ if $default }}{{ $default.RelPermalink }}{{ else }}{{ $fallback }}{{ end }}"
      alt="{{ .Title }}"
      class="absolute inset-0 w-full h-full object-contain opacity-100 transition-opacity duration-700 ease-in-out"
    />
    <img
      id="product-b"
      src=""
      alt=""
      class="absolute inset-0 w-full h-full object-contain opacity-0 pointer-events-none transition-opacity duration-700 ease-in-out"
    />
  </div>
</div>



<!-- Price + Order Now + Share button row -->
<div class="w-full max-w-xl flex justify-between items-center mb-4 py-2">
  
  <!-- Price (left) -->
  {{ with .Params.selling_price }}
  <span class="text-lg font-semibold text-xl text-lime-300">
    ₹ {{ . }}
  </span>
  {{ end }}

  <!-- Order Now (center, wide) -->
  {{ $shareColor := "/images/missing.jpg" }}
  {{ if $default }}
    {{ $shareColor = $default.RelPermalink }}
  {{ end }}
<button id="order-button" 
        data-color="{{ $shareColor }}"
        class="bg-lime-400 text-black hover:bg-lime-500 transition flex items-center gap-2 text-sm px-6 py-2 rounded font-semibold mx-5 justify-center">
  <i class="fab fa-whatsapp"></i> Order Now
</button>

  <!-- Share (right) -->
  <button id="share-button" 
          data-color="{{ $shareColor }}"
          class="hover:text-white transition flex items-center gap-1 text-sm px-3 py-1 rounded border border-zinc-700 ">
    <i class="fas fa-share-alt"></i> Share
  </button>
</div>

  <!-- Color Swatches -->
  <div id="swatch-bar" class="flex flex-wrap gap-2 justify-center max-w-xl">
    {{ $colors := .Params.colors | default slice }}
    {{ range $i, $c := $colors }}
      {{ $img := $c.image }}
      {{ $resource := or ($.Resources.GetMatch $img) ($.Resources.GetMatch (print $img ".jpeg")) }}
      {{ $resource := or $resource ($.Resources.GetMatch (print $img ".png")) }}
      {{ $default = or $default (.Resources.GetMatch (print $defaultColor ".webp")) }}
	  {{ $swatch := printf "/assets/swatches/%s.jpg" (lower (urlize $c.name)) }}
      <div class="flex flex-col items-center text-sm w-10 text-center">
        <img
          class="w-10 h-10 rounded-full border-2 cursor-pointer object-cover"
          src="{{ $swatch }}"
          alt="{{ $c.name }}"
          title="{{ $c.name }}"
          data-index="{{ $i }}"
          onclick="changeColor('{{ if $resource }}{{ $resource.RelPermalink }}{{ else }}{{ $fallback }}{{ end }}', {{ $i }})"
          id="swatch-{{ $i }}"
        />
        <span class="mt-1 text-xs text-zinc-400">{{ $c.name }}</span>
      </div>
    {{ end }}
  </div>
  <!-- Fine print below description -->
  <p class="text-xs text-zinc-500 mt-2 max-w-xl text-center italic">
    Exact color may vary depending on the display
  </p>
  <div class="product-description">
    <br>
    {{ .Content | safeHTML  }}
  </div>



</main>

<script>
let isAVisible = true;

// Build swatch list from Hugo
let swatches = [
  {{ $colors := .Params.colors | default slice }}
  {{ range $i, $c := $colors }}
    {{ $r := or ($.Resources.GetMatch $c.image) ($.Resources.GetMatch (print $c.image ".jpeg")) }}
    {{ $r := or $r ($.Resources.GetMatch (print $c.image ".png")) }}
    {
      src: "{{ if $r }}{{ $r.RelPermalink }}{{ else }}/images/missing.jpg{{ end }}",
      // already lowercased, hyphenated
      name: "{{ lower (urlize $c.name) }}"
    }{{ if not (eq (add $i 1) (len $colors)) }},{{ end }}
  {{ end }}
];

// ✅ correct default index: compare object.src (not the whole object)
let currentIndex = swatches.findIndex(el => el.src === "{{ if $default }}{{ $default.RelPermalink }}{{ else }}/images/missing.jpg{{ end }}");

// fallback to URL ?color=... if provided
const urlParams = new URLSearchParams(window.location.search);
const colorParam = urlParams.get("color");
if (colorParam && currentIndex === -1) {
  const byParam = swatches.findIndex(el => el.name === colorParam.toLowerCase());
  if (byParam >= 0) currentIndex = byParam;
}

// final fallbacks
if (currentIndex === -1) currentIndex = swatches.findIndex(el => !!el.src) // first valid
if (currentIndex === -1) currentIndex = 0; // absolute last resort

function changeColor(newSrc, newIndex) {
  const imgA = document.getElementById("product-a");
  const imgB = document.getElementById("product-b");

  if (!imgA || !imgB) return;
  if (currentIndex === newIndex) return;

  const incoming = isAVisible ? imgB : imgA;
  const outgoing = isAVisible ? imgA : imgB;

  const temp = new Image();
  temp.onload = () => {
    incoming.src = newSrc;
    incoming.classList.remove("opacity-0");
    outgoing.classList.add("opacity-0");
    isAVisible = !isAVisible;

    highlightSwatch(newIndex);
    currentIndex = newIndex;

    // keep share-button's data-color updated
    const shareButton = document.getElementById("share-button");
    if (shareButton) shareButton.setAttribute("data-color", newSrc);
  };
  temp.src = newSrc;
}

function highlightSwatch(index) {
  document.querySelectorAll('[id^="swatch-"]').forEach(el => {
    el.classList.remove("border-white");
    el.classList.add("border-zinc-700");
  });
  const active = document.getElementById(`swatch-${index}`);
  if (active) {
    active.classList.add("border-white");
    active.classList.remove("border-zinc-700");
  }
}

// initial highlight for the computed default
highlightSwatch(currentIndex);

// === Parallax (Desktop) ===
const container = document.getElementById("parallax-container");
const productWrapper = document.getElementById("product-wrapper");
if (container && productWrapper) {
  container.addEventListener("mousemove", (e) => {
    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left - rect.width / 2;
    const y = e.clientY - rect.top - rect.height / 2;
    const rotateX = (-y / rect.height) * 10;
    const rotateY = (x / rect.width) * 10;
    productWrapper.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.03)`;
  });
  container.addEventListener("mouseleave", () => {
    productWrapper.style.transform = "perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)";
  });
}

// === Share button ===
const shareBtn = document.getElementById("share-button");
if (shareBtn) {
  shareBtn.addEventListener("click", async () => {
    // ✅ read from currentIndex, not DOM class
    const colorName = swatches[currentIndex]?.name || "";
    const shareData = {
      title: document.title,
      text: "Check out this amazing product!",
      url: `${window.location.origin}${window.location.pathname}?color=${encodeURIComponent(colorName)}`
    };
    try {
      if (navigator.share) {
        await navigator.share(shareData);
      } else {
        // fallback: copy
        await navigator.clipboard.writeText(shareData.url);
        alert("Link copied!");
      }
    } catch (err) {
      console.error("Error sharing:", err);
    }
  });
}

// === Order Now button ===
const orderBtn = document.getElementById("order-button");
if (orderBtn) {
  orderBtn.addEventListener("click", () => {
    // ✅ read from currentIndex, not DOM class
    const colorName = swatches[currentIndex]?.name || "";
    const orderUrl = `${window.location.origin}${window.location.pathname}?color=${encodeURIComponent(colorName)}`;
    const message = `Hello! I’d like to order this product: ${document.title} in color ${colorName}. Here’s the link: ${orderUrl}`;

    // your WhatsApp number with country code (India)
    const phoneNumber = "919899916151";
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, "_blank");
  });
}

// === Apply URL color on page load (overrides default if present) ===
window.addEventListener("DOMContentLoaded", () => {
  const colorFromUrl = new URLSearchParams(window.location.search).get("color");
  if (colorFromUrl) {
    const idx = swatches.findIndex(el => el.name === colorFromUrl.toLowerCase());
    if (idx >= 0 && idx !== currentIndex) {
      changeColor(swatches[idx].src, idx);
    } else {
      // still ensure the correct swatch is visibly highlighted
      highlightSwatch(currentIndex);
    }
  } else {
    // ensure highlight is visible for default even without param
    highlightSwatch(currentIndex);
  }
});
</script>

{{ end }}
