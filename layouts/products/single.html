{{ define "main" }}
<main class="min-h-screen flex flex-col items-center bg-inherit text-white px-0 py-0">
  <h1 class="text-3xl font-bold text-center mb-4 tracking-wide">{{ .Title }}</h1>

<div id="parallax-container"
     class="relative w-full -mx-4 sm:-mx-6 lg:mx-auto lg:max-w-2xl aspect-[1/1] mb-2 overflow-visible border-0 lg:border lg:border-zinc-800 bg-inherit rounded-none lg:rounded-2xl">
  
  <!-- Stage Background (static) -->
  <img src="/images/stage.jpg" alt="Stage background"
       class="absolute inset-0 w-full h-full object-cover" />	

  <!-- Product images wrapper (for parallax/tilt) -->
  <div id="product-wrapper" class="absolute inset-0 w-full h-full transition-transform duration-300 ease-out will-change-transform">
    <!-- Product Image A -->
    {{ $fallback := "/images/missing.jpg" }}
    {{ $defaultColor := .Params.default_color }}
    {{ $default := or (.Resources.GetMatch $defaultColor) (.Resources.GetMatch (print $defaultColor ".jpeg")) }}
    {{ $default = or $default (.Resources.GetMatch (print $defaultColor ".png")) }}
    {{ $default = or $default (.Resources.GetMatch (print $defaultColor ".webp")) }}
	<img
      id="product-a"
      src="{{ if $default }}{{ $default.RelPermalink }}{{ else }}{{ $fallback }}{{ end }}"
      alt="{{ .Title }}"
      class="absolute inset-0 w-full h-full object-contain opacity-100 transition-opacity duration-700 ease-in-out"
    />
    <img
      id="product-b"
      src=""
      alt=""
      class="absolute inset-0 w-full h-full object-contain opacity-0 pointer-events-none transition-opacity duration-700 ease-in-out"
    />
  </div>
</div>



<!-- Price + Share button row -->
<div class="w-full max-w-xl flex justify-between items-center mb-4">
  <!-- Price -->
  {{ with .Params.selling_price }}
  <span class="text-lg font-semibold text-xl text-lime-300 mb-1">
    ₹ {{ . }}
  </span>
  {{ end }}
</div>

<!-- Share button -->
{{ $shareColor := "/images/missing.jpg" }}
{{ if $default }}
  {{ $shareColor = $default.RelPermalink }}
{{ end }}
<button id="share-button" 
        data-color="{{ $shareColor }}"
        class="hover:text-white transition flex items-center gap-1 text-sm px-3 py-1 rounded border border-zinc-700">
  <i class="fas fa-share-alt"></i> Share
</button>
</div>
  <!-- Color Swatches -->
  <div id="swatch-bar" class="flex flex-wrap gap-2 justify-center">
    {{ $colors := .Params.colors | default slice }}
    {{ range $i, $c := $colors }}
      {{ $img := $c.image }}
      {{ $resource := or ($.Resources.GetMatch $img) ($.Resources.GetMatch (print $img ".jpeg")) }}
      {{ $resource := or $resource ($.Resources.GetMatch (print $img ".png")) }}
      {{ $default = or $default (.Resources.GetMatch (print $defaultColor ".webp")) }}
	  {{ $swatch := printf "/assets/swatches/%s.jpg" (lower (urlize $c.name)) }}
      <div class="flex flex-col items-center text-sm w-10 text-center">
        <img
          class="w-10 h-10 rounded-full border-2 cursor-pointer object-cover"
          src="{{ $swatch }}"
          alt="{{ $c.name }}"
          title="{{ $c.name }}"
          data-index="{{ $i }}"
          onclick="changeColor('{{ if $resource }}{{ $resource.RelPermalink }}{{ else }}{{ $fallback }}{{ end }}', {{ $i }})"
          id="swatch-{{ $i }}"
        />
        <span class="mt-1 text-xs text-zinc-400">{{ $c.name }}</span>
      </div>
    {{ end }}
  </div>
  <!-- Fine print below description -->
  <p class="text-xs text-zinc-500 mt-2 max-w-xl text-center italic">
    Exact color may vary depending on the display
  </p>
  <div class="product-description">
    <br>
    {{ .Content | safeHTML  }}
  </div>



</main>

<script>
let isAVisible = true;
let swatches = [
  {{ $colors := .Params.colors | default slice }}
  {{ range $i, $c := $colors }}
    {{ $r := or ($.Resources.GetMatch $c.image) ($.Resources.GetMatch (print $c.image ".jpeg")) }}
    {{ $r := or $r ($.Resources.GetMatch (print $c.image ".png")) }}
    {
      src: "{{ if $r }}{{ $r.RelPermalink }}{{ else }}/images/missing.jpg{{ end }}",
      name: "{{ lower (urlize $c.name) }}"
    }{{ if not (eq (add $i 1) (len $colors)) }},{{ end }}
  {{ end }}
];

let currentIndex = swatches.findIndex(src => src === "{{ if $default }}{{ $default.RelPermalink }}{{ else }}/images/missing.jpg{{ end }}");

function changeColor(newSrc, newIndex) {
  if (currentIndex === newIndex) return;

  const imgA = document.getElementById("product-a");
  const imgB = document.getElementById("product-b");

  const incoming = isAVisible ? imgB : imgA;
  const outgoing = isAVisible ? imgA : imgB;

  const temp = new Image();
  temp.onload = () => {
    incoming.src = newSrc;
    incoming.classList.remove("opacity-0");
    outgoing.classList.add("opacity-0");
    isAVisible = !isAVisible;

    highlightSwatch(newIndex);
    currentIndex = newIndex;

    // ✅ Update share button data-color
    const shareButton = document.getElementById("share-button");
    if (shareButton) shareButton.setAttribute("data-color", newSrc);
  };
  temp.src = newSrc;
}

function highlightSwatch(index) {
  const all = document.querySelectorAll('[id^="swatch-"]');
  all.forEach(el => {
    el.classList.remove("border-white");
    el.classList.add("border-zinc-700");
  });
  const active = document.getElementById(`swatch-${index}`);
  if (active) {
    active.classList.add("border-white");
    active.classList.remove("border-zinc-700");
  }
}

highlightSwatch(currentIndex);

// === Parallax (Desktop) ===
const container = document.getElementById("parallax-container");
const productWrapper = document.getElementById("product-wrapper"); // new target for tilt

container.addEventListener("mousemove", (e) => {
  const rect = container.getBoundingClientRect();
  const x = e.clientX - rect.left - rect.width / 2;
  const y = e.clientY - rect.top - rect.height / 2;
  const rotateX = (-y / rect.height) * 10;
  const rotateY = (x / rect.width) * 10;

  // Apply transform only to product images
  productWrapper.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.03)`;
});

container.addEventListener("mouseleave", () => {
  productWrapper.style.transform = "perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)";
});

// === Swipe (Mobile) ===

//let startX = null;
//container.addEventListener("touchstart", (e) => {
  //startX = e.touches[0].clientX;
//}, { passive: true });

//container.addEventListener("touchend", (e) => {
  //if (startX === null) return;
  //const endX = e.changedTouches[0].clientX;
  //const diff = endX - startX;
  //if (Math.abs(diff) > 30) {
    //let newIndex = currentIndex;
    //if (diff < 0) newIndex = (currentIndex + 1) % swatches.length;
    //else newIndex = (currentIndex - 1 + swatches.length) % swatches.length;
    
    // ✅ Pass the src string to changeColor
    //changeColor(swatches[newIndex].src, newIndex);
  //}
  //startX = null;
//}, { passive: true });


document.getElementById("share-button").addEventListener("click", async () => {
  const activeSwatch = document.querySelector(".border-white");
  let colorName = activeSwatch ? activeSwatch.alt.toLowerCase().replace(/\s+/g, "-") : "";

  const shareData = {
    title: document.title,
    text: "Check out this amazing product!",
    url: `${window.location.origin}${window.location.pathname}?color=${encodeURIComponent(colorName)}`
  };

  try {
    if (navigator.share) {
      await navigator.share(shareData);
      console.log("Product shared successfully");
    } else {
      alert("Your browser does not support the share feature. Copy the URL instead!");
    }
  } catch (err) {
    console.error("Error sharing:", err);
  }
});

// === Apply URL color on page load ===
window.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const colorParam = urlParams.get("color"); // e.g., "pro-grey"
  if (colorParam) {
    const index = swatches.findIndex(el => el.name === colorParam.toLowerCase());
    if (index >= 0 && index !== currentIndex) {
      changeColor(swatches[index].src, index);
    }
  }
});
</script>
{{ end }}
